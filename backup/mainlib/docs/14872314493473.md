iOS即时通讯（一）—— 前言

首先我们来总结一下我们去实现IM的方式

### 第一种方式，使用第三方IM服务

对于短平快的公司，完全可以采用第三方SDK来实现。国内IM的第三方服务商有很多，类似云信、环信、融云、LeanCloud，当然还有其它的很多，这里就不一一举例了，感兴趣的小伙伴可以自行查阅下。

第三方服务商IM底层协议基本上都是TCP。他们的IM方案很成熟，有了它们，我们甚至不需要自己去搭建IM后台，什么都不需要去考虑。
如果你足够懒，甚至连UI都不需要自己做，这些第三方有各自一套IM的UI，拿来就可以直接用。真可谓3分钟集成...

但是缺点也很明显，定制化程度太高，很多东西我们不可控。当然还有一个最最重要的一点，就是太贵了...作为真正社交为主打的APP，仅此一点，就足以让我们望而却步。当然，如果IM对于APP只是一个辅助功能，那么用第三方服务也无可厚非。

### 另外一种方式，我们自己去实现

我们自己去实现也有很多选择：

1）首先面临的就是传输协议的选择，TCP还是UDP？

2）其次是我们需要去选择使用哪种聊天协议：

* 基于Scoket或者WebScoket或者其他的私有协议、
* MQTT
* 还是广为人诟病的XMPP?

3）我们是自己去基于OS底层Socket进行封装还是在第三方框架的基础上进行封装？

4）传输数据的格式，我们是用Json、还是XML、还是谷歌推出的ProtocolBuffer？

5）我们还有一些细节问题需要考虑，例如TCP的长连接如何保持，心跳机制，Qos机制，重连机制等等...当然，除此之外，我们还有一些安全问题需要考虑。

### 一、传输协议的选择

接下来我们可能需要自己考虑去实现IM，首先从传输层协议来说，我们有两种选择：TCP or UDP？

![TCPorUDP.png](http://cc.cocimg.com/api/uploads/20170109/1483967999242078.png)

这个问题已经被讨论过无数次了，对深层次的细节感兴趣的朋友可以看看这篇文章：[移动端IM/推送系统的协议选型：UDP还是TCP？](http://www.52im.net/thread-33-1-1.html)

这里我们直接说结论吧：对于小公司或者技术不那么成熟的公司，IM一定要用TCP来实现，因为如果你要用UDP的话，需要做的事太多。当然QQ就是用的UDP协议，当然不仅仅是UDP，腾讯还用了自己的私有协议，来保证了传输的可靠性，杜绝了UDP下各种数据丢包，乱序等等一系列问题。

总之一句话，如果你觉得团队技术很成熟，那么你用UDP也行，否则还是用TCP为好。

### 二、我们来看看各种聊天协议

首先我们以实现方式来切入，基本上有以下四种实现方式：

* 基于Scoket原生：代表框架 CocoaAsyncSocket。
* 基于WebScoket：代表框架 SocketRocket。
* 基于MQTT：代表框架 MQTTKit。
* 基于XMPP：代表框架 XMPPFramework。

当然，以上四种方式我们都可以不使用第三方框架，直接基于OS底层Scoket去实现我们的自定义封装。下面我会给出一个基于Scoket原生而不使用框架的例子，供大家参考一下。

首先需要搞清楚的是，其中MQTT和XMPP为聊天协议，它们是最上层的协议，而WebScoket是传输通讯协议，它是基于Socket封装的一个协议。而通常我们所说的腾讯IM的私有协议，就是基于WebScoket或者Scoket原生进行封装的一个聊天协议。

具体这3种聊天协议的对比优劣如下：

![协议优劣对比.png](http://cc.cocimg.com/api/uploads/20170109/1483968080731120.png)

所以说到底，iOS要做一个真正的IM产品，一般都是基于Scoket或者WebScoket等，再之上加上一些私有协议来保证的。

